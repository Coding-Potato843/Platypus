# Platypus Mobile App - Technical Documentation

## Overview
React Native (Expo) companion app for the Platypus photo sharing web service.
Enables photo import from device gallery to Supabase.

---

## Tech Stack
- **Framework**: React Native + Expo SDK 54.0.33
- **Language**: TypeScript
- **React**: 19.1.0
- **React Native**: 0.81.5 (must match Expo Go version)
- **Backend**: Supabase (same as web frontend)
- **Navigation**: React Navigation v7
- **State**: React hooks (useAuth custom hook)
- **Layout**: SafeAreaProvider (react-native-safe-area-context)

---

## Supabase Configuration
```typescript
SUPABASE_URL = 'https://vtpgatnkobvjqwvoqtad.supabase.co'
SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...'
```
Same credentials as web frontend. Uses AsyncStorage for session persistence.

---

## File Structure
```
app/
├── package.json                # Dependencies
├── app.json                    # Expo config (permissions, icons)
├── tsconfig.json               # TypeScript config
├── babel.config.js             # Babel config
├── App.tsx                     # Entry point (navigation + auth routing)
├── src/
│   ├── config/
│   │   └── supabase.ts         # Supabase client (AsyncStorage session)
│   ├── types/
│   │   └── index.ts            # TypeScript types (User, Photo, GalleryFilter, etc.)
│   ├── hooks/
│   │   └── useAuth.ts          # Auth state hook (login, logout, profile)
│   ├── services/
│   │   ├── auth.ts             # Auth functions (login, logout, getSession)
│   │   ├── photos.ts           # Photo upload (gallery scan, fetchAllPhotos, upload)
│   │   └── geocoding.ts        # Reverse geocoding (GPS → location name)
│   ├── components/
│   │   ├── LoadingOverlay.tsx  # Full-screen loading modal
│   │   ├── PhotoGrid.tsx       # Photo grid with selection checkmarks
│   │   ├── GalleryPickerModal.tsx  # Gallery picker with filtering
│   │   ├── DateRangePicker.tsx     # Year/month date picker
│   │   ├── FilterBar.tsx           # Collapsible filter UI
│   │   └── PermissionModal.tsx     # Gallery permission request modal
│   └── screens/
│       ├── LoginScreen.tsx     # Email/password login form
│       └── SyncScreen.tsx      # Main sync UI (scan, gallery picker, upload)
└── assets/
    ├── icon.png                # App icon (1024x1024)
    ├── splash.png              # Splash screen
    └── adaptive-icon.png       # Android adaptive icon
```

---

## Core Features

### 1. Authentication (LoginScreen.tsx)
- Email/password login via Supabase Auth
- Session persistence via AsyncStorage
- Korean UI text
- Auto-navigation to SyncScreen on successful login

### 2. Permission Request (PermissionModal.tsx)
- Shows only ONCE on first app launch after installation (persisted via AsyncStorage)
- Clean UI explaining why permission is needed
- Step-by-step guide: "1. 권한 → 2. 사진 및 동영상 → 3. 허용"
- Two buttons:
  - "설정으로 이동" (primary, cyan) - Opens app settings via `Linking.openSettings()`
  - "알겠습니다" (secondary, gray text) - Dismisses modal permanently
- Privacy note reassuring user about data safety
- Uses AsyncStorage key `permissionModalShown` to prevent showing again

### 3. Gallery Import (SyncScreen.tsx)

**Two Import Methods:**

#### Method 1: "갤러리 스캔" (Auto Scan)
1. User taps "갤러리 스캔" button
2. App requests gallery permission (expo-media-library)
3. Scans all photos from device
4. Filters: only photos with `modificationTime > last_sync_at` (last scan date)
5. Displays in grid with ALL photos PRE-SELECTED
6. User taps to DESELECT unwanted photos
7. User taps "업로드" button
8. Photos uploaded to Supabase Storage + Database
9. `last_sync_at` (last scan date) updated in user profile

#### Method 2: "갤러리에서 선택" (Manual Picker)
1. User taps "갤러리에서 선택" button
2. Opens GalleryPickerModal with ALL gallery photos (no date filter)
3. User can apply filters:
   - **Date Range**: Select start/end year-month
   - **Location Search**: Text search for location name
4. User taps to SELECT wanted photos (NOT pre-selected)
5. User taps "선택 완료" → Photos added to main list
6. User taps "업로드" to upload

**Key UX:**
- **Auto Scan**: Photos are selected by DEFAULT (checkmark visible)
- **Gallery Picker**: Photos are NOT selected by default (user selects manually)
- "전체 선택" / "전체 해제" buttons for bulk operations
- Progress indicator during upload
- "추가 선택" button to add more photos after initial selection

### 4. Gallery Picker Modal (GalleryPickerModal.tsx)

**Features:**
- Full-screen modal with infinite scroll (50 photos per batch)
- Native-level date filtering (`createdAfter`/`createdBefore` in MediaLibrary API)
- Client-side location search (partial text match)
- Background geocoding for visible photos
- Duplicate prevention (already-added photos shown as disabled)

**Filter UI (FilterBar.tsx):**
- Collapsible filter section
- Date range with DateRangePicker
- Location text input with clear button
- "필터 초기화" button

**DateRangePicker.tsx:**
- Year/Month scroll list selection (not native calendar)
- Cancel button (red, left) / Confirm button (sky blue, right) at bottom
- Future date prevention (max = current date)
- No native module dependency (works in Expo Go)

### 5. Photo Services (services/photos.ts)

**Key Functions:**

1. **`fetchPhotosAfterDate(afterDate)`** - Auto scan
   - Scans ALL albums including Downloads, Telegram, WhatsApp, KakaoTalk
   - Uses `modificationTime` (not `creationTime`) for filtering
   - Camera photos: modificationTime ≈ creationTime
   - Downloaded images: modificationTime = download time
   - Pre-selects all photos (`selected: true`)
   - Deduplicates across albums using Map

2. **`fetchAllPhotos(options)`** - Manual picker
   - Fetches all photos with pagination (50 per batch)
   - Scans all albums on first page load (`includeAllAlbums: true`)
   - Supports native date filtering: `createdAfter`, `createdBefore`
   - Does NOT pre-select photos (`selected: false`)
   - Returns `{ photos, hasNextPage, endCursor }`

**Scanned Albums:**
```javascript
['download', 'downloads', '다운로드', 'telegram', 'whatsapp', 'kakaotalk']
```

3. **`uploadPhoto(userId, photo)`** - Single upload
   - Read photo as base64 (FileSystem.readAsStringAsync)
   - Convert to Uint8Array
   - Upload to Supabase Storage: `{userId}/{timestamp}_{random}.{ext}`
   - Get public URL
   - Determine date_taken (priority: EXIF > modificationTime > creationTime > now)
   - Reverse geocode if GPS available
   - Insert record to 'photos' table

**Upload Date Priority:**
Downloaded images often lack EXIF data and may have invalid creationTime (0 = 1970-01-01).
Priority order: EXIF DateTimeOriginal > modificationTime > creationTime > current time

4. **`uploadPhotos(userId, photos, onProgress)`** - Batch upload with duplicate detection
   - Calculates SHA-256 hash for each photo before upload
   - Batch queries database to find existing hashes
   - Skips duplicate photos automatically
   - Sequential upload with progress tracking
   - Returns `{ success, failed, skipped }` counts

5. **`calculateFileHash(uri)`** - Hash calculation
   - Uses expo-crypto for SHA-256 hashing
   - Requires development build (not available in Expo Go)
   - Returns hex string of file hash

6. **`checkDuplicateHashes(userId, hashes)`** - Duplicate check
   - Batch query to check multiple hashes at once
   - Returns Set of existing hashes

### 6. Reverse Geocoding (services/geocoding.ts)
- Uses OpenStreetMap Nominatim API (free, no API key)
- Rate limited: 1 request per second
- Converts GPS coordinates → location name
- Example: (37.5665, 126.9780) → "서울특별시, 중구"
- Results cached to reduce API calls

### 7. Duplicate Detection (services/photos.ts)

SHA-256 hash-based duplicate photo prevention.

**How It Works:**
1. Before upload, calculate SHA-256 hash of each photo using expo-crypto
2. Batch query database to check for existing hashes
3. Skip photos whose hashes already exist
4. Upload new photos with hash stored in `file_hash` column

**Progress Callback:**
```typescript
onProgress(current: number, total: number, status: 'hashing' | 'uploading')
```

**UI Feedback:**
- During hash calculation: "중복 검사 중... X/Y"
- During upload: "업로드 중... X/Y"
- Result alert: "3장 성공, 2장 중복 제외"

**Requirements:**
- **expo-crypto**: Native module required (must use development build, not Expo Go)
- **Database**: `file_hash` column and index on photos table

**Performance:**
- Hash calculation: ~100-200ms per 5MB photo
- Batch query: ~50-100ms for 100 hashes
- Total overhead: ~2-3 seconds for 100 photos

---

## Database Schema (Same as Web)

### users table
| Column | Type | Description |
|--------|------|-------------|
| id | uuid | PK (same as auth.users.id) |
| email | text | User email |
| username | text | Display name |
| last_sync_at | timestamp | Last scan date (CRITICAL for incremental import) |

### photos table
| Column | Type | Description |
|--------|------|-------------|
| id | uuid | PK |
| user_id | uuid | FK → users.id |
| url | text | Photo URL from Storage |
| date_taken | timestamp | When photo was taken |
| location | text | Location name |
| file_hash | text | SHA-256 hash for duplicate detection |
| created_at | timestamp | Upload time |

---

## Permissions

### iOS (app.json)
- `NSPhotoLibraryUsageDescription`: Gallery access for sync

### Android (app.json)
- `READ_EXTERNAL_STORAGE`: Legacy storage access
- `READ_MEDIA_IMAGES`: Android 13+ media access
- `ACCESS_MEDIA_LOCATION`: Required for reading GPS data from photo EXIF

### expo-media-library Plugin Config
```json
{
  "photosPermission": "사진을 불러오려면 갤러리 접근 권한이 필요합니다.",
  "savePhotosPermission": "사진을 저장하려면 갤러리 접근 권한이 필요합니다.",
  "isAccessMediaLocationEnabled": true
}
```

---

## UI Theme (Match Web)
- Background: `#0f172a` (slate-900)
- Card: `#1e293b` (slate-800)
- Primary: `#06b6d4` (cyan-500)
- Text: `#f1f5f9` (slate-100)
- Border: `#334155` (slate-700)
- Error: `#ef4444` (red-500)

---

## UI Terminology (Korean)

| English | Korean (UI) | Notes |
|---------|-------------|-------|
| Last Scan Date | 마지막 스캔 날짜 | Displayed on SyncScreen |
| Gallery Scan | 갤러리 스캔 | Auto-scan button |
| Select from Gallery | 갤러리에서 선택 | Manual picker button |
| Scan Complete | 스캔 완료 | Alert title |
| Photo Management App | 사진 관리 앱 | LoginScreen subtitle |
| Permission Required | 갤러리 접근 권한 필요 | Permission modal title |
| Go to Settings | 설정으로 이동 | Permission modal primary button |
| I Understand | 알겠습니다 | Permission modal dismiss button |

**Note**: The word "동기화" (sync) is NOT used in the UI. Use "불러오기" (import/load) or "스캔" (scan) instead.

---

## Key TypeScript Types

```typescript
interface PhotoAsset {
  id: string;
  uri: string;               // Local file URI
  filename: string;
  creationTime: number;      // Timestamp (ms)
  modificationTime: number;
  width: number;
  height: number;
  mediaType: string;
  exif?: {
    DateTimeOriginal?: string;
    GPSLatitude?: number;
    GPSLongitude?: number;
  };
  selected: boolean;         // UI selection state
  location?: string | null;  // Reverse geocoded location
}

interface UserProfile {
  id: string;
  email: string;
  username: string;
  last_sync_at: string | null;  // ISO date string
}

// NEW: Gallery filter for picker modal
interface GalleryFilter {
  startDate: Date | null;    // Filter start (year-month)
  endDate: Date | null;      // Filter end (year-month)
  locationSearch: string;    // Location text search
}
```

---

## Development Commands

```bash
# Install dependencies (MUST use --legacy-peer-deps due to React 19 conflicts)
cd app
npm install --legacy-peer-deps

# Start Expo dev server (tunnel mode for mobile access)
npm start
# or
npx expo start --tunnel

# Run on Android
npm run android

# Run on iOS (Mac only)
npm run ios

# Clean reinstall (if issues occur)
rm -rf node_modules package-lock.json .expo
npm install --legacy-peer-deps
```

## EAS Build (Development APK)

Expo Go has limitations with media library access on Android.
Use EAS Build to create a development APK with full permissions:

```bash
# Install EAS CLI globally
npm install -g eas-cli

# Login to Expo account
eas login

# Configure EAS (first time only)
eas build:configure

# Build development APK for Android
eas build --profile development --platform android
```

After build completes, download the APK from Expo dashboard and install on device.

---

## Testing Checklist

### Permission Modal (First Launch)
1. **Fresh Install**: Uninstall and reinstall app (or clear app data)
2. **First Launch**: Modal should appear on first launch
3. **Dismiss**: Tap "알겠습니다" to close modal
4. **Restart App**: Modal should NOT appear again
5. **Grant Permission**: Go to Settings manually and grant permission
6. **Verify**: App should work normally without modal appearing

### Auto Scan ("갤러리 스캔")
1. **Login**: Use existing Platypus web account
2. **Permission**: Grant gallery access when prompted (if not already)
3. **Scan**: Tap "갤러리 스캔" to load photos
4. **Selection**: Verify photos are pre-selected, tap to deselect
5. **Upload**: Tap "업로드" and watch progress
6. **Verify on Web**: Login to web frontend, check uploaded photos appear
7. **Incremental Import**: Upload again, verify only NEW photos shown
8. **Downloaded Images**: Verify images from Downloads folder appear in scan
9. **Messenger Images**: Verify images from Telegram/WhatsApp/KakaoTalk appear

### Gallery Picker ("갤러리에서 선택")
1. **Open Picker**: Tap "갤러리에서 선택" to open modal
2. **Infinite Scroll**: Scroll down to load more photos
3. **Date Filter**: Set start/end date, verify filtered results
4. **Location Filter**: Search for location name (e.g., "서울")
5. **Selection**: Tap photos to select (not pre-selected)
6. **Confirm**: Tap "선택 완료" to add to main list
7. **Upload**: Verify selected photos upload correctly
8. **Old Photos**: Confirm photos before last scan date can be selected
9. **Downloaded Images**: Verify downloaded images appear in picker

### Downloaded Image Date Handling
1. **Download Image**: Download an image from the internet
2. **Scan/Pick**: Include the downloaded image in upload
3. **Upload**: Upload the downloaded image
4. **Verify Date**: Check on web that date is download time (NOT 1970-01-01)

### Duplicate Detection
1. **First Upload**: Upload a set of photos
2. **Verify Hashes**: Check database that file_hash column is populated
3. **Re-upload Same Photos**: Try to upload the same photos again
4. **Verify Skip**: Confirm message shows "X장 중복 제외"
5. **Mixed Upload**: Upload mix of new and duplicate photos
6. **Verify Partial**: Confirm only new photos are uploaded, duplicates skipped

---

## Important Notes

1. **Same Supabase Database**: Photos uploaded from this app appear on web gallery
2. **RLS Enabled**: Users can only access their own data
3. **last_sync_at**: Critical for incremental import - only imports photos newer than this timestamp (last scan date)
4. **Storage Path**: `{userId}/{timestamp}_{random}.{ext}` (same pattern as web)
5. **No Registration**: Users must register on web first, then login via app
6. **Duplicate Detection**: Requires development build (expo-crypto native module). Expo Go will throw "Cannot find native module 'ExpoCrypto'" error
7. **file_hash Column**: Must be added to photos table before using duplicate detection feature

---

## Error Handling

- **Permission Denied**: Alert with clear message, retry option
- **Upload Failure**: Individual photo failures logged, continue with others
- **Network Error**: Toast/Alert with error message
- **Empty Gallery**: Message "새로운 사진이 없습니다"

---

## Development Notes (Windows)

### Known Issues & Solutions

1. **node:sea path error (Expo SDK 50)**
   - Windows doesn't allow colons in directory names
   - Solution: Upgrade to Expo SDK 54

2. **Port 8081 already in use**
   - Previous Expo process still running
   - Solution: Kill all node.exe in Task Manager, or PowerShell:
     ```powershell
     Get-Process -Name node | Stop-Process -Force
     ```

3. **Dependency conflicts (peer deps)**
   - React 19 vs React Native peer dependency issues
   - Solution: Use `npm install --legacy-peer-deps`

4. **babel-preset-expo not found**
   - Missing after dependency reinstall
   - Solution: `npm install babel-preset-expo --legacy-peer-deps`

5. **React Native version mismatch (Black screen on mobile)**
   - Error: "JavaScript version: 0.77.0, Native version: 0.81.4"
   - Cause: Expo Go app requires specific React Native version
   - Solution: Update package.json to use `react-native: 0.81.5` and all Expo packages to SDK 54 compatible versions
   - Run: `rm -rf node_modules package-lock.json && npm install --legacy-peer-deps`

6. **Expo Go media library limitation**
   - Warning: "Expo Go can no longer provide full access to the media library"
   - Cause: Android permission changes
   - Solution: Use EAS Build to create development APK

7. **ACCESS_MEDIA_LOCATION permission error**
   - Error: "Cannot access ExifInterface because of missing ACCESS_MEDIA_LOCATION permission"
   - Cause: Android requires explicit permission for GPS EXIF data
   - Solution: Add `ACCESS_MEDIA_LOCATION` to permissions and `isAccessMediaLocationEnabled: true` in expo-media-library plugin

8. **expo-file-system deprecated API**
   - Error: "Method readAsStringAsync imported from expo-file-system is deprecated"
   - Cause: expo-file-system v19 changed API
   - Solution: Import from `expo-file-system/legacy` instead

9. **expo-crypto native module not found**
   - Error: "Cannot find native module 'ExpoCrypto'"
   - Cause: expo-crypto requires native code, not available in Expo Go
   - Solution: Use EAS Build to create development APK with native modules included

### Useful Commands
```bash
# Clean reinstall
rm -rf node_modules package-lock.json
npm install --legacy-peer-deps

# Clear cache and start
npx expo start --clear

# Build for web (test compilation)
npx expo export --platform web

# Serve built web app
npx serve dist
```

---

## Current Status

### Working (Development Build)
- ✅ Login/Logout with Supabase Auth
- ✅ Auth state persistence (AsyncStorage)
- ✅ Navigation between screens
- ✅ Dark theme UI matching web
- ✅ **Permission Request Modal** - Shows only once on first launch (persisted via AsyncStorage)
- ✅ Gallery auto-scan (expo-media-library)
- ✅ EXIF extraction (date, GPS coordinates)
- ✅ ACCESS_MEDIA_LOCATION permission for GPS data
- ✅ Photo upload to Supabase Storage
- ✅ Reverse geocoding (GPS → location name)
- ✅ Incremental import (only photos after last scan date)
- ✅ **Gallery Picker Modal** - Select any photos regardless of sync date
- ✅ **Date Range Filter** - Year/month selection with native-level filtering
- ✅ **Location Search** - Text-based location filtering
- ✅ **Custom DateRangePicker** - No native module dependency
- ✅ **All Albums Scan** - Includes Downloads, Telegram, WhatsApp, KakaoTalk
- ✅ **Downloaded Image Support** - Proper date handling using modificationTime
- ✅ **Duplicate Detection** - SHA-256 hash-based duplicate photo prevention

### Notes
- **Development build required**: Expo Go has limitations with media library access and lacks expo-crypto native module
- **Manual import only**: Background upload is NOT planned
- **expo-file-system/legacy**: Uses legacy API for `readAsStringAsync`
- **Gallery Picker works in Expo Go**: DateRangePicker is pure JS, no native modules
- **modificationTime**: Used for filtering instead of creationTime to catch downloaded images
- **expo-crypto**: Native module for SHA-256 hashing, requires development build for duplicate detection

---

## Future Enhancements (TODO)

- [ ] Photo preview before upload (full-screen view)
- [ ] Settings screen (data usage options)
- [ ] Group assignment during sync
- [ ] Offline queue for poor connectivity
- [ ] iOS development build

## Completed Enhancements

- [x] **Gallery Picker** - Select photos before last scan date
- [x] **Date Range Filter** - Native-level date filtering
- [x] **Location Search** - Client-side text filtering
- [x] **Custom Date Picker** - Year/month scroll selection without native modules
- [x] **All Albums Scan** - Downloads, Telegram, WhatsApp, KakaoTalk support
- [x] **Downloaded Image Date Fix** - Uses modificationTime for proper dating
- [x] **UI Cleanup** - Removed camera icon, filter icon; streamlined date picker buttons
- [x] **Permission Modal** - First-launch only permission request (persisted via AsyncStorage), step-by-step guide, "알겠습니다" dismiss button
- [x] **Duplicate Detection** - SHA-256 hash-based duplicate photo prevention (uses expo-crypto)
