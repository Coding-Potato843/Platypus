# Platypus Mobile App - Technical Documentation

## Overview
React Native (Expo) companion app for native gallery photo import to Supabase.
No registration — users must register on web first, then login via app.

## Tech Stack
- Expo SDK 54.0.33, React 19.1.0, React Native 0.81.5, TypeScript
- React Navigation v7, SafeAreaProvider
- Backend: Same Supabase instance as web (see CLAUDE.md for config)
- Session persistence via AsyncStorage
- **Development build required** — Expo Go lacks expo-media-library full access and expo-crypto

---

## File Structure
```
app/
├── App.tsx                     # Entry point (navigation + auth routing)
├── app.json                    # Expo config (permissions, icons)
├── package.json, tsconfig.json, babel.config.js
├── src/
│   ├── config/supabase.ts      # Supabase client (AsyncStorage session)
│   ├── types/index.ts          # TypeScript types
│   ├── hooks/useAuth.ts        # Auth state hook (login, logout, profile)
│   ├── services/
│   │   ├── auth.ts             # Auth functions
│   │   ├── photos.ts           # Gallery scan, photo upload, duplicate detection
│   │   └── geocoding.ts        # Reverse geocoding (Nominatim, cached, 1 req/sec)
│   ├── components/
│   │   ├── PhotoGrid.tsx       # Photo grid with selection checkmarks
│   │   ├── GalleryPickerModal.tsx  # Full gallery picker with filtering
│   │   ├── DateRangePicker.tsx     # Year/month scroll picker (pure JS, no native deps)
│   │   ├── FilterBar.tsx           # Collapsible filter UI
│   │   ├── PermissionModal.tsx     # Gallery permission request after denial
│   │   ├── LastSyncDateEditor.tsx  # Manual last scan date editor
│   │   ├── CustomAlert.tsx     # Dark theme alert + toast (replaces Alert.alert)
│   │   └── LoadingOverlay.tsx  # Full-screen loading modal
│   └── screens/
│       ├── LoginScreen.tsx     # Email/password login
│       └── SyncScreen.tsx      # Main screen: tab UI, scan, picker, upload
└── assets/                     # icon.png, splash.png, adaptive-icon.png
```

---

## Core Features

### Authentication (LoginScreen.tsx)
- Email/password login via Supabase Auth, session persisted in AsyncStorage
- Auto-navigation to SyncScreen on login
- Korean UI text

### Permission Request (PermissionModal.tsx)
- Triggered only when user taps scan/select button (NOT on app launch)
- Flow: System dialog first → if denied → custom PermissionModal with settings guide
- AppState listener re-checks permission when returning from settings
- Stateless (no AsyncStorage flags)

### Tab-Based Import (SyncScreen.tsx)

Two tabs with independent photo lists:

| Feature | Gallery Scan (갤러리 스캔) | Select from Gallery (갤러리에서 선택) |
|---------|--------------------------|--------------------------------------|
| Last scan date | Shown (with "수정" edit button) | Hidden |
| Photo selection | All PRE-SELECTED | None selected |
| Date filtering | After `last_sync_at` only | No restriction |
| Updates `last_sync_at` | Yes | No |
| Button labels | "갤러리 스캔" / "다시 스캔" | "갤러리에서 선택" / "추가 선택" |

- Active tab: cyan background; tabs preserve photo lists when switching
- "전체 선택" / "전체 해제" for bulk selection
- Upload button with progress indicator

### Gallery Picker Modal (GalleryPickerModal.tsx)
- Full-screen modal, infinite scroll (50/batch)
- Date filtering: native-level via MediaLibrary `createdAfter`/`createdBefore`
- Location filtering: client-side text search (partial match)
- Already-added photos shown as disabled
- FilterBar.tsx: collapsible section with DateRangePicker + location input

### Last Sync Date Editor (LastSyncDateEditor.tsx)
- "수정" button in Gallery Scan tab, opens modal with year/month/day/hour/minute pickers
- Only allows past to current time; "현재 시간으로 설정" quick-set button
- Clears scan photos list after date change
- Date format: `YY년 M월 D일 오전/오후 H:MM`

### Custom Alert & Toast (CustomAlert.tsx)
Replaces system `Alert.alert()` for dark theme consistency.

```typescript
const { showAlert, AlertComponent } = useCustomAlert();
const { showToast, ToastComponent } = useToast();

showAlert('Title', 'Message', [
  { text: 'Cancel', style: 'cancel' },       // gray, bottom
  { text: 'Confirm', onPress: handleConfirm }, // cyan, top
]);
showToast('3장 업로드 완료');  // auto-dismiss 2.5s

// Must render <AlertComponent /> and <ToastComponent /> in JSX
```

Button styles: default (cyan), cancel (gray), destructive (red). Order: action top, cancel bottom.

---

## Photo Services (services/photos.ts)

### Key Functions

**`fetchPhotosAfterDate(afterDate)`** — Gallery Scan tab
- Scans ALL albums: Camera, Downloads/다운로드, Telegram, WhatsApp, KakaoTalk
- Filters by `modificationTime > afterDate` (not creationTime — catches downloaded images)
- Pre-selects all photos; deduplicates across albums via Map

**`fetchAllPhotos(options)`** — Gallery Picker modal
- Pagination (50/batch), returns `{ photos, hasNextPage, endCursor }`
- Native date filtering: `createdAfter`/`createdBefore`
- Does NOT pre-select photos

**`uploadPhoto(userId, photo)`** — Single upload
- Read as base64 → Uint8Array → Supabase Storage (`{userId}/{timestamp}_{random}.{ext}`)
- date_taken priority: EXIF DateTimeOriginal > modificationTime > creationTime > now
- Reverse geocode if GPS available → insert to photos table

**`uploadPhotos(userId, photos, onProgress)`** — Batch upload with dedup
- SHA-256 hash each photo (expo-crypto) → batch check DB → skip duplicates → upload
- Progress: `onProgress(current, total, 'hashing' | 'uploading')`
- Returns `{ success, failed, skipped }`

**`calculateFileHash(uri)`** / **`checkDuplicateHashes(userId, hashes)`**
- expo-crypto SHA-256; requires dev build (Expo Go throws "Cannot find native module 'ExpoCrypto'")

### GPS Location Extraction
Two sources checked in order:
1. `assetInfo.location.latitude/longitude` (expo-media-library standard)
2. `assetInfo.exif.GPSLatitude/GPSLongitude` (raw EXIF fallback)

---

## TypeScript Types

```typescript
interface PhotoAsset {
  id: string;
  uri: string;               // Local file URI
  filename: string;
  creationTime: number;      // Timestamp (ms)
  modificationTime: number;
  width: number;
  height: number;
  mediaType: string;
  exif?: { DateTimeOriginal?: string; GPSLatitude?: number; GPSLongitude?: number; };
  selected: boolean;         // UI selection state
  location?: string | null;  // Reverse geocoded location
}

interface UserProfile {
  id: string;
  email: string;
  username: string;
  last_sync_at: string | null;
}

interface GalleryFilter {
  startDate: Date | null;
  endDate: Date | null;
  locationSearch: string;
}
```

---

## Permissions

### Android (app.json)
- `READ_EXTERNAL_STORAGE` (Android < 13), `READ_MEDIA_IMAGES` (13+), `READ_MEDIA_VISUAL_USER_SELECTED` (14+)
- `ACCESS_MEDIA_LOCATION` — required for GPS EXIF data

### iOS (app.json)
- `NSPhotoLibraryUsageDescription`

### expo-media-library plugin
```json
{ "photosPermission": "사진을 불러오려면 갤러리 접근 권한이 필요합니다.",
  "savePhotosPermission": "사진을 저장하려면 갤러리 접근 권한이 필요합니다.",
  "isAccessMediaLocationEnabled": true }
```

---

## UI Theme
| Token | Value | Name |
|-------|-------|------|
| Background | `#0f172a` | slate-900 |
| Card | `#1e293b` | slate-800 |
| Primary | `#06b6d4` | cyan-500 |
| Text | `#f1f5f9` | slate-100 |
| Border | `#334155` | slate-700 |
| Error | `#ef4444` | red-500 |

---

## UI Terminology (Korean)

| English | Korean | Context |
|---------|--------|---------|
| Last Scan Date | 마지막 스캔 날짜 | Gallery Scan tab |
| Gallery Scan | 갤러리 스캔 | Auto-scan button/tab |
| Select from Gallery | 갤러리에서 선택 | Manual picker button/tab |
| Scan Complete | 스캔 완료 | Alert title |
| Photo Management App | 사진 관리 앱 | Login subtitle |
| Permission Required | 갤러리 접근 권한 필요 | Permission modal |
| Go to Settings | 설정으로 이동 | Permission modal button |
| I Understand | 알겠습니다 | Permission modal dismiss |

> **"동기화" (sync) is NOT used** in UI. Use "불러오기" (import) or "스캔" (scan).

---

## Development

### Commands
```bash
cd app
npm install --legacy-peer-deps          # MUST use --legacy-peer-deps (React 19 conflicts)
npx expo start --tunnel                 # Dev server with QR code
npx expo start --clear                  # Clear cache and start
```

### EAS Build (required for full functionality)
```bash
npm install -g eas-cli && eas login
eas build:configure                     # First time only
eas build --profile development --platform android
```
Download APK from Expo dashboard after build.

### Clean Reinstall
```bash
rm -rf node_modules package-lock.json .expo && npm install --legacy-peer-deps
```

---

## Known Issues (Windows)

| Error | Solution |
|-------|----------|
| Port 8081 in use | Kill node.exe: `Get-Process -Name node \| Stop-Process -Force` |
| Peer dependency conflicts | Always use `--legacy-peer-deps` |
| `babel-preset-expo` not found | `npm install babel-preset-expo --legacy-peer-deps` |
| RN version mismatch / black screen | Ensure `react-native: 0.81.5` matches Expo SDK 54; clean reinstall |
| Expo Go media library limitation | Use EAS development build |
| `ACCESS_MEDIA_LOCATION` error | Add permission to app.json + `isAccessMediaLocationEnabled: true` |
| `expo-file-system` deprecated API | Import from `expo-file-system/legacy` |
| `ExpoCrypto` native module not found | Use EAS development build (not Expo Go) |

---

## Important Notes
- Same Supabase database as web — uploaded photos appear in web gallery
- Storage path: `{userId}/{timestamp}_{random}.{ext}` (same as web)
- `last_sync_at` is ONLY updated by Gallery Scan tab upload; web and Select from Gallery do NOT update it
- `modificationTime` used for scan filtering (not `creationTime`) to catch downloaded images
- `expo-file-system/legacy` required for `readAsStringAsync`
- Double back press to exit (Android only, 2s window with toast)
- Manual import only — background upload not planned

---

## Future TODO
- Photo preview before upload (full-screen view)
- Settings screen (data usage options)
- Group assignment during sync
- Offline queue for poor connectivity
- iOS development build
